<html><head><meta http-equiv="Content-Type" content="no-cache; charset=UTF-8"><script src="DragObject.js"></script><script src="DropTarget.js"></script><script src="dragMaster.js"></script><script src="helpers.js"></script><style>.uponMe { background-color: red; }div { 	background-color: white; 	font-family:Arial;	font-size:10px;}</style></head><body>    <!--<center><h3>Определите расписание преподавателя</h3></center>-->    <?phpfunction getXByName($nam, $den) {	$c = 0;	if(substr($nam, 0, 3) == "mon") $c = 0;	if(substr($nam, 0, 3) == "tue") $c = 1;	if(substr($nam, 0, 3) == "wed") $c = 2;	if(substr($nam, 0, 3) == "thr") $c = 3;	if(substr($nam, 0, 3) == "fri") $c = 4;	if(substr($nam, 0, 3) == "sat") $c = 5;	return 55 + 158 * $c;}function getYByName($nam, $den) {	$c = 0;	if(substr($nam, 4, 2) == "8_") $c = 0;	if(substr($nam, 4, 2) == "9_") $c = 1;	if(substr($nam, 4, 2) == "11") $c = 2;	if(substr($nam, 4, 2) == "13") $c = 3;	if(substr($nam, 4, 2) == "15") $c = 4;	if(substr($nam, 4, 2) == "16") $c = 5;	if(substr($nam, 4, 2) == "18") $c = 6;	$kf = 0;	if($den == 'true') $kf = 40;	return 79 + 83 * $c + $kf;}?><form method="GET" id="fr1" name="fr1"><table><tr><td><input type="text" id="nams" name="nams" hidden="true" value=<?php echo $_GET['nams']; ?>></td></tr></table></form><table><tr><td><table>    <tr align="center">        <td></td>        <td style="font-family:Arial; font-size:14px;">Mon.</td>        <td style="font-family:Arial; font-size:14px;">Tue.</td>        <td style="font-family:Arial; font-size:14px;">Wed.</td>        <td style="font-family:Arial; font-size:14px;">Thr.</td>        <td style="font-family:Arial; font-size:14px;">Fri.</td>        <td style="font-family:Arial; font-size:14px;">Sat.</td>    </tr>    <tr>        <td style="font-family:Arial; font-size:14px;">8:00</td>        <td><div style="border: 2px black solid; height: 75px; width: 150px" id="mon_8_00"></div></td>        <td><div style="border: 2px black solid; height: 75px; width: 150px" id="tue_8_00"></div></td>        <td><div style="border: 2px black solid; height: 75px; width: 150px" id="wed_8_00"></div></td>        <td><div style="border: 2px black solid; height: 75px; width: 150px" id="thr_8_00"></div></td>        <td><div style="border: 2px black solid; height: 75px; width: 150px" id="fri_8_00"></div></td>        <td><div style="border: 2px black solid; height: 75px; width: 150px" id="sat_8_00"></div></td>    </tr>    <tr>        <td style="font-family:Arial; font-size:14px;">9:40</td>        <td><div style="border: 2px black solid; height: 75px; width: 150px" id="mon_9_40"></div></td>        <td><div style="border: 2px black solid; height: 75px; width: 150px" id="tue_9_40"></div></td>        <td><div style="border: 2px black solid; height: 75px; width: 150px" id="wed_9_40"></div></td>        <td><div style="border: 2px black solid; height: 75px; width: 150px" id="thr_9_40"></div></td>        <td><div style="border: 2px black solid; height: 75px; width: 150px" id="fri_9_40"></div></td>        <td><div style="border: 2px black solid; height: 75px; width: 150px" id="sat_9_40"></div></td>    </tr>    <tr>        <td style="font-family:Arial; font-size:14px;">11:30</td>        <td><div style="border: 2px black solid; height: 75px; width: 150px" id="mon_11_30"></div></td>        <td><div style="border: 2px black solid; height: 75px; width: 150px" id="tue_11_30"></div></td>        <td><div style="border: 2px black solid; height: 75px; width: 150px" id="wed_11_30"></div></td>        <td><div style="border: 2px black solid; height: 75px; width: 150px" id="thr_11_30"></div></td>        <td><div style="border: 2px black solid; height: 75px; width: 150px" id="fri_11_30"></div></td>        <td><div style="border: 2px black solid; height: 75px; width: 150px" id="sat_11_30"></div></td>    </tr>    <tr>        <td style="font-family:Arial; font-size:14px;">13:30</td>        <td><div style="border: 2px black solid; height: 75px; width: 150px" id="mon_13_30"></div></td>        <td><div style="border: 2px black solid; height: 75px; width: 150px" id="tue_13_30"></div></td>        <td><div style="border: 2px black solid; height: 75px; width: 150px" id="wed_13_30"></div></td>        <td><div style="border: 2px black solid; height: 75px; width: 150px" id="thr_13_30"></div></td>        <td><div style="border: 2px black solid; height: 75px; width: 150px" id="fri_13_30"></div></td>        <td><div style="border: 2px black solid; height: 75px; width: 150px" id="sat_13_30"></div></td>    </tr>    <tr>        <td style="font-family:Arial; font-size:14px;">15:10</td>        <td><div style="border: 2px black solid; height: 75px; width: 150px" id="mon_15_10"></div></td>        <td><div style="border: 2px black solid; height: 75px; width: 150px" id="tue_15_10"></div></td>        <td><div style="border: 2px black solid; height: 75px; width: 150px" id="wed_15_10"></div></td>        <td><div style="border: 2px black solid; height: 75px; width: 150px" id="thr_15_10"></div></td>        <td><div style="border: 2px black solid; height: 75px; width: 150px" id="fri_15_10"></div></td>        <td><div style="border: 2px black solid; height: 75px; width: 150px" id="sat_15_10"></div></td>    </tr>    <tr>        <td style="font-family:Arial; font-size:14px;">16:40</td>        <td><div style="border: 2px black solid; height: 75px; width: 150px" id="mon_16_40"></div></td>        <td><div style="border: 2px black solid; height: 75px; width: 150px" id="tue_16_40"></div></td>        <td><div style="border: 2px black solid; height: 75px; width: 150px" id="wed_16_40"></div></td>        <td><div style="border: 2px black solid; height: 75px; width: 150px" id="thr_16_40"></div></td>        <td><div style="border: 2px black solid; height: 75px; width: 150px" id="fri_16_40"></div></td>        <td><div style="border: 2px black solid; height: 75px; width: 150px" id="sat_16_40"></div></td>    </tr>    <tr>        <td style="font-family:Arial; font-size:14px;">18:40</td>        <td><div style="border: 2px black solid; height: 75px; width: 150px" id="mon_18_40"></div></td>        <td><div style="border: 2px black solid; height: 75px; width: 150px" id="tue_18_40"></div></td>        <td><div style="border: 2px black solid; height: 75px; width: 150px" id="wed_18_40"></div></td>        <td><div style="border: 2px black solid; height: 75px; width: 150px" id="thr_18_40"></div></td>        <td><div style="border: 2px black solid; height: 75px; width: 150px" id="fri_18_40"></div></td>        <td><div style="border: 2px black solid; height: 75px; width: 150px" id="sat_18_40"></div></td>    </tr></table></td><td>    <table>        <th>            <!--<td style="font-family:Arial; font-size:14px;">                Не распределенные предметы:            </td>-->        </th>        <tr>            <td>                <div id="dragObjects">                    <?php                        /** Include path **/                        set_include_path(get_include_path().PATH_SEPARATOR.'Classes/');                        /** PHPExcel_IOFactory */                        include 'PHPExcel/IOFactory.php';                        $inputFileName = './example.xlsx';                        $objPHPExcel = PHPExcel_IOFactory::load($inputFileName);                        $f1 = './scheds/' . $_GET['nams'] . 'Spring.xml';                        $f2 = './scheds/' . $_GET['nams'] . 'Autumn.xml';                        if(file_exists($f1)) copy($f1, 'ttSpring.xml'); else @unlink('ttSpring.xml');                        if(file_exists($f2)) copy($f2, 'ttAutumn.xml'); else @unlink('ttAutumn.xml');                        $sheetData = $objPHPExcel->getActiveSheet()->toArray(null,true,true,true);                        $sem = 0;                        if(isset($_GET['semestr'])) {                                if($_GET['semestr'] == 'Autumn') $sem = 1;                        } else { $_GET['semestr'] = 'Autumn'; $sem = 1;}                        $file_nam = 'tt' . $_GET['semestr'] . '.xml';                        $cury = 150;                        $curx = 1000;                        if(file_exists($file_nam))                            $timtabl = simplexml_load_file($file_nam);                        $tim = array();                        if(isset($timtabl)) {                            foreach($timtabl as $at) {                                $tim[(string)$at->attributes()->subj]['den'] = $at->attributes()->denm;                                $tim[(string)$at->attributes()->subj]['tim'] = $at->attributes()->time;                            }                        }                        $totalCountDivs = 0;                        for($i = 2; $i < count($sheetData); $i++) {                            if($sheetData[$i]["F"] % 2 != $sem) continue;                            $nagr = $sheetData[$i]["L"] + $sheetData[$i]["N"] + $sheetData[$i]["P"];                            if($nagr == 0) continue;                                $n = 1;                                $arr = array();                                $n = 0;                                $vol = $sheetData[$i]["L"]; //lectures                                while($vol > 0)                                {                                    $arr[$n++] = "Лекция";                                    $vol -= 18;                                }                                $vol = $sheetData[$i]["N"]; //practics                                while($vol > 0)                                {                                    $arr[$n++] = "Практика";                                    $vol -= 18;                                }                                $vol = $sheetData[$i]["P"]; //labs                                while($vol > 0)                                {                                    $arr[$n++] = "Лабораторная работа";                                    $vol -= 18;                                }                                //iconv("windows-1251", "UTF-8", $sheetData[$i]["A"]);                                for($j = 0; $j < $n; $j++) {                                    $totalCountDivs++;                                    $tp = ' top: ' . (string)$cury . 'px;';                                    $cury += 38;                                    $lft = "left: " . $curx . "px;";                                    if($totalCountDivs > 10) {                                        $totalCountDivs = 0;                                        $cury = 150;                                        $curx += 160;                                    }                                    if(isset($tim['s' . (string)$i . (string)$j])) {                                            $tp = ' top: ' . (string)getYByName($tim['s' . (string)$i . (string)$j]['tim'], $tim['s' . (string)$i . (string)$j]['den']) . 'px;';                                            $lft = ' left: ' . (string)getXByName($tim['s' . (string)$i . (string)$j]['tim'], $tim['s' . (string)$i . (string)$j]['den']) . 'px;';                                    }                                                                        echo '<div title="' . $sheetData[$i]["E"] . ' курс, ' . $sheetData[$i]["C"] . ', ' . $arr[$j] . '" style="position: fixed; border: 1px black solid; height: 35px; width: 150px; ' . $tp . $lft . '" id="s' . (string)$i . (string)$j . '" ';                                    if(isset($tim['s' . (string)$i . (string)$j])) {                                            echo 'where="' . $tim['s' . (string)$i . (string)$j]['tim'] . '" ';                                            echo 'denom="' . $tim['s' . (string)$i . (string)$j]['den'] . '" ';                                    }                                    echo '>';                                    echo $sheetData[$i]["A"];                                    echo ': ' . $arr[$j];                                    echo '</div>';                                    echo "\n";                                }}                        $totalCountDivs++;                        if($totalCountDivs > 10) {                            $totalCountDivs = 0;                            $cury = 150;                            $curx += 160;                        }                        if(isset($tim['KS1'])) {                            $tp = (string)getYByName($tim['KS1']['tim'], $tim['KS1']['den']);                            $lft = (string)getXByName($tim['KS1']['tim'], $tim['KS1']['den']);                        } else {                            $tp = $cury;                             $cury += 38;                            $lft = $curx;                        }                        echo '<div style="position: fixed; border: 1px black solid; height: 35px; width: 150px; ' . ' top: ' . $tp . 'px;' . ' left: ' . $lft . 'px;" id="KS1"';                        if(isset($tim['KS1'])) {                            echo 'where="' . $tim['KS1']['tim'] . '" ';                            echo 'denom="' . $tim['KS1']['den'] . '" ';                        }                        echo '>Консультация</div>';                        $totalCountDivs++;                        if($totalCountDivs > 10) {                            $totalCountDivs = 0;                            $cury = 150;                            $curx += 160;                        }                        if(isset($tim['KS2'])) {                            $tp = (string)getYByName($tim['KS2']['tim'], $tim['KS2']['den']);                            $lft = (string)getXByName($tim['KS2']['tim'], $tim['KS2']['den']);                        } else {                            $tp = $cury;                            $lft = $curx;                        }                        echo '<div style="position: fixed; border: 1px black solid; height: 35px; width: 150px; ' . ' top: ' . $tp . 'px;' . ' left: ' . $lft . 'px;" id="KS2"';                        if(isset($tim['KS2'])) {                            echo 'where="' . $tim['KS2']['tim'] . '" ';                            echo 'denom="' . $tim['KS2']['den'] . '" ';                        }                        echo '>Консультация</div><br>';                    ?>                </div>            </td>        </tr>    </table></td></table><script>onload = function() {    var dragObjects = document.getElementById('dragObjects').getElementsByTagName('div');	var d_o = new Array();    for(var i=0; i<dragObjects.length; i++) {        d_o[i] = new DragObject(dragObjects[i]);    }        var weekdays = ['mon', 'tue', 'wed', 'thr', 'fri', 'sat'];    var times = ['8_00', '9_40', '11_30', '13_30', '15_10', '16_40', '18_40'];    for(var i = 0; i < 6; i++) {        for(var j = 0; j < 7; j++) {            new DropTarget(document.getElementById(weekdays[i] + '_' + times[j]));        }    }	    for(var i=0; i<dragObjects.length; i++) {        dragObjects[i].where = document.getElementById(dragObjects[i].getAttribute('where')).dropTarget;        dragObjects[i].denom = dragObjects[i].getAttribute('denom');    }}</script><script>function out() {    var dragObjects = document.getElementById('dragObjects').getElementsByTagName('div');    var XML1 = document.createElement("div");    XML = document.createElement("timetable");    XML1.appendChild(XML);    for(var i = 0; i < dragObjects.length; i++) {        var node = document.createElement("at");        node.setAttribute('time', dragObjects[i].where.toString());        node.setAttribute('subj', dragObjects[i].id);        node.setAttribute('denm', dragObjects[i].denom);        node.setAttribute('kurs',  dragObjects[i].title.substr(0, 1));        var tit = dragObjects[i].title.toString();        if(tit.length > 8) {            var spec = tit.substr(8, tit.length).substr(0, tit.substr(8, tit.length).indexOf(','));            node.setAttribute('spec',  spec);            tit = tit.substr(8, tit.length).substr(tit.substr(8, tit.length).indexOf(',') + 2, tit.length);            node.setAttribute('type',  tit);        } else        {            node.setAttribute('spec',  '');            node.setAttribute('type',  'Консультация');        }        var yr = new Date().getFullYear();        var x = document.getElementById('semestr');        if(x[0].text == 'Spring') {            node.setAttribute('beg', '01.02.' + yr);            node.setAttribute('end', '01.07.' + yr);        } else {            node.setAttribute('beg', '01.09.' + yr);            node.setAttribute('end', '31.12.' + yr);        }        node.setAttribute('name', dragObjects[i].innerHTML);        XML.appendChild(node);    }    	//alert(XML1.innerHTML);    document.getElementById('inp').value = XML1.innerHTML;    document.forms['frm'].submit();}</script><script>function out1() {    document.forms['frm1'].submit();}</script><center><?php    echo '<form id="frm" method="POST" action="writer.php?nams=' . $_GET['nams'] . '">';?>    <input type="text" id="inp" name="data" hidden="true">    <input type="text" id="sem" name="sem" hidden="true" value="<?php echo $_GET['semestr']; ?>">    <input type="button" id="send" onclick="out();" value="Save timetable"></form></center><center><form id="frm1" method="POST" action="printer.php">    <input type="text" id="sem1" name="sem1" hidden="true" value="<?php echo $_GET['semestr']; ?>">    <input type="button" id="send" onclick="out1();" value="Print log"></form></center><br></body></html>